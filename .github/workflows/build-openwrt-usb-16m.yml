name: Build OpenWrt (USB + 16M flash)

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'Wersja OpenWrt (tag git, np. v22.03.7, v23.05.5)'
        required: true
        default: 'v22.03.7'
      target:
        description: 'Target (np. ramips, ath79, x86, mediatek)'
        required: true
        default: 'ramips'
      subtarget:
        description: 'Subtarget (np. mt76x8, mt7621, generic, 64)'
        required: true
        default: 'mt76x8'
      profile:
        description: 'Profil urządzenia (np. tplink_tl-wr841n-v13)'
        required: true
        default: 'tplink_tl-wr841n-v13'
      extra_packages:
        description: 'Dodatkowe pakiety oddzielone spacją (np. kmod-usb-storage kmod-fs-ext4). Zostaw puste jeśli nie potrzeba.'
        required: false
        default: ''
      create_release:
        description: 'Czy utworzyć GitHub Release z firmware?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  VERSION: ${{ github.event.inputs.openwrt_version }}
  TARGET: ${{ github.event.inputs.target }}
  SUBTARGET: ${{ github.event.inputs.subtarget }}
  PROFILE: ${{ github.event.inputs.profile }}

jobs:
  build:
    name: "OpenWrt ${{ github.event.inputs.openwrt_version }} | ${{ github.event.inputs.target }}/${{ github.event.inputs.subtarget }} | ${{ github.event.inputs.profile }} | USB+16M"
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout OpenWrt ${{ env.VERSION }}
        uses: actions/checkout@v4
        with:
          repository: openwrt/openwrt
          ref: ${{ env.VERSION }}
          fetch-depth: 1

      - name: Instalacja zależności systemowych
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev \
            libssl-dev python3-distutils rsync unzip zlib1g-dev \
            file wget qemu-utils

      - name: Zwolnienie miejsca na dysku (~20 GB)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get autoremove -y && sudo apt-get clean
          df -h

      - name: Aktualizacja i instalacja feedów
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Cache – toolchain (staging_dir)
        uses: actions/cache@v4
        with:
          path: |
            staging_dir/host
            staging_dir/toolchain-*
          key: openwrt-toolchain-${{ env.VERSION }}-${{ env.TARGET }}-${{ env.SUBTARGET }}

      - name: Cache – pobrane źródła (dl/)
        uses: actions/cache@v4
        with:
          path: dl/
          key: openwrt-dl-${{ env.VERSION }}-${{ env.TARGET }}-${{ env.SUBTARGET }}
      - name: Generowanie .config
        run: |
          # Ustaw target, subtarget i profil urządzenia
          echo "CONFIG_TARGET_${TARGET}=y"                                    > .config
          echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y"                      >> .config
          echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${PROFILE}=y"   >> .config

          # Pakiety USB (wymagane do obsługi kontrolera EHCI/OHCI po USB modzie)
          echo "CONFIG_PACKAGE_kmod-usb2=y"                                  >> .config
          echo "CONFIG_PACKAGE_kmod-usb-ledtrig-usbport=y"                  >> .config

          # Dodatkowe pakiety podane przez użytkownika
          EXTRA_PKGS="${{ github.event.inputs.extra_packages }}"
          if [ -n "$EXTRA_PKGS" ]; then
            for pkg in $EXTRA_PKGS; do
              echo "CONFIG_PACKAGE_${pkg}=y" >> .config
            done
          fi

          make defconfig

          echo "=== Aktywny target ==="
          grep "^CONFIG_TARGET" .config
          echo "=== Pakiety USB ==="
          grep "^CONFIG_PACKAGE_kmod-usb" .config || echo "(brak)"

      # ──────────────────────────────────────────────────────────────
      # PATCH 1: Nowy plik dtsi z układem flash 16MB
      # Oryginalny mt7628an_tplink_8m.dtsi (8MB):
      #   firmware: reg = <0x20000 0x7a0000>   (7808 KB)
      #   config:   reg = <0x7c0000 0x10000>
      #   factory:  reg = <0x7d0000 0x30000>
      # Nowy mt7628an_tplink_16m.dtsi (16MB):
      #   firmware: reg = <0x20000 0xfa0000>   (16000 KB)
      #   config:   reg = <0xfc0000 0x10000>
      #   factory:  reg = <0xfd0000 0x30000>
      # ──────────────────────────────────────────────────────────────
      - name: Patch 1 – Tworzenie mt7628an_tplink_16m.dtsi (układ flash 16MB)
        run: |
          DTSI_8M="target/linux/ramips/dts/mt7628an_tplink_8m.dtsi"
          DTSI_16M="target/linux/ramips/dts/mt7628an_tplink_16m.dtsi"

          if [ ! -f "$DTSI_8M" ]; then
            echo "ERROR: Nie znaleziono $DTSI_8M"
            exit 1
          fi

          sed \
            -e 's|reg = <0x20000 0x7a0000>|reg = <0x20000 0xfa0000>|' \
            -e 's|reg = <0x7c0000 0x10000>|reg = <0xfc0000 0x10000>|' \
            -e 's|reg = <0x7d0000 0x30000>|reg = <0xfd0000 0x30000>|' \
            "$DTSI_8M" > "$DTSI_16M"

          echo "=== Partycje w nowym 16MB dtsi ==="
          grep "reg = " "$DTSI_16M"
          echo "INFO: Patch 1 OK – $DTSI_16M utworzony"

      # ──────────────────────────────────────────────────────────────
      # PATCH 2: Zmiana #include w DTS urządzenia
      # mt7628an_tplink_tl-wr841n-v13.dts:
      #   #include "mt7628an_tplink_8m.dtsi"  →  #include "mt7628an_tplink_16m.dtsi"
      # ──────────────────────────────────────────────────────────────
      - name: Patch 2 – Zmiana #include w DTS urządzenia na 16m
        run: |
          DTS="target/linux/ramips/dts/mt7628an_tplink_tl-wr841n-v13.dts"

          if [ ! -f "$DTS" ]; then
            echo "ERROR: Nie znaleziono $DTS"
            exit 1
          fi

          if grep -q "mt7628an_tplink_16m.dtsi" "$DTS"; then
            echo "INFO: Patch 2 już zastosowany – pomijam."
          else
            sed -i 's|mt7628an_tplink_8m.dtsi|mt7628an_tplink_16m.dtsi|' "$DTS"
            echo "INFO: Patch 2 OK – include zaktualizowany."
          fi

          echo "=== Nagłówek DTS po patchu ==="
          head -3 "$DTS"

      # ──────────────────────────────────────────────────────────────
      # PATCH 3: Aktualizacja IMAGE_SIZE i TPLINK_FLASHLAYOUT w mt76x8.mk
      #   IMAGE_SIZE := 7808k  →  16000k
      #   TPLINK_FLASHLAYOUT := 8Mmtk  →  16Mmtk
      # (zmiana tylko w bloku Device/tplink_tl-wr841n-v13)
      # ──────────────────────────────────────────────────────────────
      - name: Patch 3 – Aktualizacja IMAGE_SIZE i FLASHLAYOUT w mt76x8.mk
        run: |
          MK="target/linux/ramips/image/mt76x8.mk"

          if [ ! -f "$MK" ]; then
            echo "ERROR: Nie znaleziono $MK"
            exit 1
          fi

          # Zmień IMAGE_SIZE i FLASHLAYOUT tylko wewnątrz bloku WR841N v13
          sed -i '/Device\/tplink_tl-wr841n-v13/,/endef/s/IMAGE_SIZE := 7808k/IMAGE_SIZE := 16000k/' "$MK"
          sed -i '/Device\/tplink_tl-wr841n-v13/,/endef/s/TPLINK_FLASHLAYOUT := 8Mmtk/TPLINK_FLASHLAYOUT := 16Mmtk/' "$MK"

          echo "=== Blok Device/tplink_tl-wr841n-v13 po patchu ==="
          sed -n '/Device\/tplink_tl-wr841n-v13/,/endef/p' "$MK"

          # Weryfikacja
          grep -A20 "Device/tplink_tl-wr841n-v13" "$MK" | grep "IMAGE_SIZE" | grep "16000k" \
            && echo "INFO: Patch 3 OK – IMAGE_SIZE = 16000k" \
            || echo "WARN: IMAGE_SIZE nie zostalo zmienione – sprawdz mk!"

      # ──────────────────────────────────────────────────────────────
      # PATCH 4: USB – włączenie EHCI (USB 2.0) i OHCI (USB 1.1)
      # Zgodnie z: https://forum.openwrt.org/t/wr841n-v13-usb-mod/9098
      # DTS już zawiera &ehci { status = "disabled"; } – appendujemy "okay"
      # ──────────────────────────────────────────────────────────────
      - name: Patch 4 – Włączenie kontrolera USB (EHCI/OHCI) w DTS
        run: |
          DTS="target/linux/ramips/dts/mt7628an_tplink_tl-wr841n-v13.dts"

          if grep -q "ehci.*status.*okay" "$DTS"; then
            echo "INFO: Patch USB już obecny – pomijam."
          else
            echo "" >> "$DTS"
            echo "/* USB mod patch – enable EHCI (USB 2.0) and OHCI (USB 1.1) */" >> "$DTS"
            echo "&ehci { status = \"okay\"; };" >> "$DTS"
            echo "&ohci { status = \"okay\"; };" >> "$DTS"
            echo "INFO: Patch 4 OK – EHCI/OHCI enabled."
          fi

          echo "=== Ostatnie 8 linii DTS ==="
          tail -8 "$DTS"

      - name: Pobieranie plików źródłowych
        run: |
          make download -j$(nproc) V=s 2>&1 | tail -50
          find dl -size -1024c -delete

      - name: Kompilacja (toolchain + firmware)
        run: |
          make -j$(nproc) V=s 2>&1 | tee build.log | tail -100

      - name: Logi błędów (tylko przy niepowodzeniu)
        if: failure()
        run: |
          echo "=== Ostatnie 300 linii build.log ==="
          tail -300 build.log
          df -h

      - name: Zbieranie plików firmware
        if: success()
        run: |
          mkdir -p firmware
          find bin/targets/${TARGET}/${SUBTARGET}/ \
            -type f \( -name "*.bin" -o -name "*.img" -o -name "*.img.gz" \
                      -o -name "*.ubi" -o -name "*.trx" \) \
            -exec cp {} firmware/ \;

          cp bin/targets/${TARGET}/${SUBTARGET}/profiles.json  firmware/ 2>/dev/null || true
          cp bin/targets/${TARGET}/${SUBTARGET}/config.buildinfo firmware/ 2>/dev/null || true

          echo "=== Pliki firmware ==="
          ls -lh firmware/
          echo "=== Weryfikacja rozmiaru (powinien byc ~12-15MB) ==="
          find firmware/ -name "*.bin" -exec du -h {} \;

      - name: Upload firmware → GitHub Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: "openwrt-${{ env.VERSION }}-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ env.PROFILE }}-usb-16m-build${{ github.run_number }}"
          path: firmware/
          retention-days: 30
          if-no-files-found: error

      - name: Tworzenie GitHub Release (opcjonalne)
        if: success() && github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "openwrt-${{ env.VERSION }}-usb-16m-build${{ github.run_number }}"
          name: "OpenWrt ${{ env.VERSION }} | ${{ env.TARGET }}/${{ env.SUBTARGET }} | ${{ env.PROFILE }} | USB + 16MB flash"
          body: |
            ## OpenWrt Build – USB mod + 16MB Flash

            Firmware skompilowany z obsługą USB (EHCI/OHCI) i układem flash 16MB dla TL-WR841N v13.

            > **Uwaga:** Wymaga dwóch fizycznych modów sprzętowych:
            > 1. Wymiana chipa flash 8MB → 16MB (np. Winbond W25Q128, GigaDevice GD25Q128)
            > 2. Przylutowanie złącza USB
            > Wgraj via TFTP, NIE przez interfejs webowy TP-Link.

            | Parametr          | Wartość |
            |-------------------|---------| 
            | Wersja OpenWrt    | `${{ env.VERSION }}` |
            | Target            | `${{ env.TARGET }}` |
            | Subtarget         | `${{ env.SUBTARGET }}` |
            | Profil            | `${{ env.PROFILE }}` |
            | Flash             | `16MB (TPLINK_FLASHLAYOUT=16Mmtk, IMAGE_SIZE=16000k)` |
            | Pakiety USB       | `kmod-usb2 kmod-usb-ledtrig-usbport` |
            | Dodatkowe pakiety | `${{ github.event.inputs.extra_packages || 'brak' }}` |
            | Commit źródłowy   | `${{ github.sha }}` |
          files: firmware/*
          draft: false
          prerelease: false
