name: Build OpenWrt

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target (np. ath79, x86, ramips, mediatek)'
        required: true
        default: 'x86'
      subtarget:
        description: 'Subtarget (np. 64, generic, mt7621, filogic)'
        required: true
        default: '64'
      profile:
        description: 'Profil urzÄ…dzenia (np. generic, tplink_archer-c7-v2). Zostaw "generic" jeĹ›li nie wiesz.'
        required: true
        default: 'generic'
      extra_packages:
        description: 'Dodatkowe pakiety oddzielone spacjÄ… (np. luci htop nano). Zostaw puste jeĹ›li nie potrzeba.'
        required: false
        default: ''
      create_release:
        description: 'Czy utworzyÄ‡ GitHub Release z firmware? (true/false)'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  TARGET: ${{ github.event.inputs.target }}
  SUBTARGET: ${{ github.event.inputs.subtarget }}
  PROFILE: ${{ github.event.inputs.profile }}

jobs:
  build:
    name: Build OpenWrt (${{ github.event.inputs.target }}/${{ github.event.inputs.subtarget }})
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repozytorium
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Instalacja zaleĹĽnoĹ›ci systemowych
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev \
            libssl-dev python3-distutils rsync unzip zlib1g-dev \
            file wget qemu-utils

      - name: Konfiguracja wolnego miejsca na dysku
        run: |
          sudo df -h
          # UsuĹ„ niepotrzebne pakiety aby zyskaÄ‡ miejsce (~20GB)
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get autoremove -y
          sudo apt-get clean
          sudo df -h

      - name: Aktualizacja i instalacja feedĂłw
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generowanie .config z profilu
        run: |
          echo "CONFIG_TARGET_${TARGET}=y" > .config
          echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
          echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${PROFILE}=y" >> .config
          
          # Dodaj dodatkowe pakiety jeĹ›li podane
          EXTRA_PKGS="${{ github.event.inputs.extra_packages }}"
          if [ -n "$EXTRA_PKGS" ]; then
            for pkg in $EXTRA_PKGS; do
              echo "CONFIG_PACKAGE_${pkg}=y" >> .config
            done
          fi
          
          make defconfig
          
          # PokaĹĽ wygenerowanÄ… konfiguracjÄ™ targetu
          echo "--- Konfiguracja targetu ---"
          grep "^CONFIG_TARGET" .config

      - name: WyĹ›wietl konfiguracjÄ™ (diagnostyka)
        run: |
          echo "=== Cel kompilacji ==="
          echo "Target:    $TARGET"
          echo "Subtarget: $SUBTARGET"
          echo "Profile:   $PROFILE"
          echo "=== .config (pierwsze 40 linii) ==="
          head -40 .config

      - name: Pobieranie plikĂłw ĹşrĂłdĹ‚owych
        run: |
          make download -j$(nproc) V=s 2>&1 | tail -50
          # SprawdĹş integralnoĹ›Ä‡ pobranych plikĂłw
          find dl -size -1024c -delete

      - name: Kompilacja toolchaina i firmware
        run: |
          make -j$(nproc) V=s 2>&1 | tee build.log | tail -100
          echo "=== Wynik kompilacji ==="
          echo "Kod wyjĹ›cia: $?"

      - name: Diagnostyka przy bĹ‚Ä™dzie (jeĹ›li kompilacja siÄ™ nie powiodĹ‚a)
        if: failure()
        run: |
          echo "=== Ostatnie 200 linii build.log ==="
          tail -200 build.log
          echo "=== Wolne miejsce na dysku ==="
          df -h

      - name: Zbieranie plikĂłw firmware
        if: success()
        run: |
          mkdir -p collected_firmware
          # Kopiuj obrazy firmware (bin, img, gz, itx, ubi)
          find bin/targets/$TARGET/$SUBTARGET/ \
            -type f \( -name "*.bin" -o -name "*.img" -o -name "*.img.gz" \
                      -o -name "*.itx" -o -name "*.ubi" -o -name "*.trx" \) \
            -exec cp {} collected_firmware/ \;
          
          echo "=== Znalezione pliki firmware ==="
          ls -lh collected_firmware/ || echo "Brak plikĂłw firmware!"
          
          # Kopiuj teĹĽ profiles.json i config.buildinfo
          cp bin/targets/$TARGET/$SUBTARGET/profiles.json collected_firmware/ 2>/dev/null || true
          cp bin/targets/$TARGET/$SUBTARGET/config.buildinfo collected_firmware/ 2>/dev/null || true

      - name: Upload firmware jako GitHub Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ env.PROFILE }}-${{ github.run_number }}
          path: collected_firmware/
          retention-days: 30
          if-no-files-found: warn

      - name: Tworzenie GitHub Release (opcjonalne)
        if: success() && github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}-${{ env.TARGET }}-${{ env.SUBTARGET }}
          name: "OpenWrt ${{ env.TARGET }}/${{ env.SUBTARGET }} - Build #${{ github.run_number }}"
          body: |
            ## OpenWrt Build
            
            | Parametr   | WartoĹ›Ä‡ |
            |------------|---------|
            | Target     | `${{ env.TARGET }}` |
            | Subtarget  | `${{ env.SUBTARGET }}` |
            | Profile    | `${{ env.PROFILE }}` |
            | Commit     | `${{ github.sha }}` |
            | Data       | `${{ github.event.repository.updated_at }}` |
            
            ### Dodatkowe pakiety
            `${{ github.event.inputs.extra_packages || 'brak' }}`
          files: collected_firmware/*
          draft: false
          prerelease: false
