name: Build OpenWrt (USB + 16M flash + LuCI PL)

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'Wersja OpenWrt (tag git, np. v22.03.7, v23.05.5)'
        required: true
        default: 'v22.03.7'
      target:
        description: 'Target (np. ramips, ath79, x86, mediatek)'
        required: true
        default: 'ramips'
      subtarget:
        description: 'Subtarget (np. mt76x8, mt7621, generic, 64)'
        required: true
        default: 'mt76x8'
      profile:
        description: 'Profil urządzenia (np. tplink_tl-wr841n-v13)'
        required: true
        default: 'tplink_tl-wr841n-v13'
      extra_packages:
        description: 'Dodatkowe pakiety oddzielone spacją (np. kmod-usb-storage kmod-fs-ext4). Zostaw puste jeśli nie potrzeba.'
        required: false
        default: ''
      create_release:
        description: 'Czy utworzyć GitHub Release z firmware?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  VERSION: ${{ github.event.inputs.openwrt_version }}
  TARGET: ${{ github.event.inputs.target }}
  SUBTARGET: ${{ github.event.inputs.subtarget }}
  PROFILE: ${{ github.event.inputs.profile }}

jobs:
  build:
    name: "OpenWrt ${{ github.event.inputs.openwrt_version }} | ${{ github.event.inputs.target }}/${{ github.event.inputs.subtarget }} | ${{ github.event.inputs.profile }} | USB+16M+LuCI PL"
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout OpenWrt ${{ env.VERSION }}
        uses: actions/checkout@v4
        with:
          repository: openwrt/openwrt
          ref: ${{ env.VERSION }}
          fetch-depth: 1

      - name: Instalacja zależności systemowych
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev \
            libssl-dev python3-distutils rsync unzip zlib1g-dev \
            file wget qemu-utils

      - name: Zwolnienie miejsca na dysku (~20 GB)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get autoremove -y && sudo apt-get clean
          df -h

      - name: Aktualizacja i instalacja feedów
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Cache – toolchain (staging_dir)
        uses: actions/cache@v4
        with:
          path: |
            staging_dir/host
            staging_dir/toolchain-*
          key: openwrt-toolchain-${{ env.VERSION }}-${{ env.TARGET }}-${{ env.SUBTARGET }}

      - name: Cache – pobrane źródła (dl/)
        uses: actions/cache@v4
        with:
          path: dl/
          key: openwrt-dl-${{ env.VERSION }}-${{ env.TARGET }}-${{ env.SUBTARGET }}

      - name: Generowanie .config
        run: |
          # Ustaw target, subtarget i profil urządzenia
          echo "CONFIG_TARGET_${TARGET}=y"                                    > .config
          echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y"                      >> .config
          echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${PROFILE}=y"   >> .config

          # Pakiety USB
          echo "CONFIG_PACKAGE_kmod-usb2=y"                                  >> .config
          echo "CONFIG_PACKAGE_kmod-usb-ledtrig-usbport=y"                  >> .config

          # LuCI – interfejs webowy z językiem polskim
          echo "CONFIG_PACKAGE_luci=y"                                        >> .config
          echo "CONFIG_PACKAGE_luci-i18n-base-pl=y"                          >> .config

          # Usuń PPP – zbędne bez DSL (oszczędność ~100 KB flash i ~0 KB RAM przy braku PPPoE)
          echo "CONFIG_PACKAGE_ppp=n"                                         >> .config
          echo "CONFIG_PACKAGE_ppp-mod-pppoe=n"                              >> .config

          # Dodatkowe pakiety podane przez użytkownika
          EXTRA_PKGS="${{ github.event.inputs.extra_packages }}"
          if [ -n "$EXTRA_PKGS" ]; then
            for pkg in $EXTRA_PKGS; do
              echo "CONFIG_PACKAGE_${pkg}=y" >> .config
            done
          fi

          make defconfig

          echo "=== Aktywny target ==="
          grep "^CONFIG_TARGET" .config
          echo "=== Pakiety USB ==="
          grep "^CONFIG_PACKAGE_kmod-usb" .config || echo "(brak)"
          echo "=== LuCI ==="
          grep "^CONFIG_PACKAGE_luci" .config

      - name: Patch 1 – Tworzenie mt7628an_tplink_16m.dtsi (układ flash 16MB)
        run: |
          DTSI_8M="target/linux/ramips/dts/mt7628an_tplink_8m.dtsi"
          DTSI_16M="target/linux/ramips/dts/mt7628an_tplink_16m.dtsi"
          [ ! -f "$DTSI_8M" ] && echo "ERROR: Brak $DTSI_8M" && exit 1
          sed \
            -e 's|reg = <0x20000 0x7a0000>|reg = <0x20000 0xfa0000>|' \
            -e 's|reg = <0x7c0000 0x10000>|reg = <0xfc0000 0x10000>|' \
            -e 's|reg = <0x7d0000 0x30000>|reg = <0xfd0000 0x30000>|' \
            "$DTSI_8M" > "$DTSI_16M"
          echo "=== Partycje w nowym 16MB dtsi ==="
          grep "reg = " "$DTSI_16M"

      - name: Patch 2 – Zmiana #include w DTS urządzenia na 16m
        run: |
          DTS="target/linux/ramips/dts/mt7628an_tplink_tl-wr841n-v13.dts"
          [ ! -f "$DTS" ] && echo "ERROR: Brak $DTS" && exit 1
          grep -q "mt7628an_tplink_16m.dtsi" "$DTS" \
            && echo "INFO: Patch 2 juz zastosowany." \
            || sed -i 's|mt7628an_tplink_8m.dtsi|mt7628an_tplink_16m.dtsi|' "$DTS"
          head -3 "$DTS"

      # Patch 3 (IMAGE_SIZE/FLASHLAYOUT) USUNIĘTY:
      # mktplinkfw2 w v22.03.7 nie obsługuje layout 16Mmtk → brak .bin
      # DTS z 16MB partition table wystarczy – overlay używa extra ~8MB.

      - name: Patch 3 – Włączenie kontrolera USB (EHCI/OHCI) w DTS
        run: |
          DTS="target/linux/ramips/dts/mt7628an_tplink_tl-wr841n-v13.dts"
          if grep -q "ehci.*status.*okay" "$DTS"; then
            echo "INFO: Patch USB juz obecny – pomijam."
          else
            echo "" >> "$DTS"
            echo "/* USB mod patch – enable EHCI (USB 2.0) and OHCI (USB 1.1) */" >> "$DTS"
            echo "&ehci { status = \"okay\"; };" >> "$DTS"
            echo "&ohci { status = \"okay\"; };" >> "$DTS"
            echo "INFO: Patch USB zastosowany."
          fi
          tail -6 "$DTS"

      - name: Pobieranie plików źródłowych
        run: |
          make download -j$(nproc) V=s 2>&1 | tail -50
          find dl -size -1024c -delete

      - name: Kompilacja (toolchain + firmware)
        run: |
          set -o pipefail
          make -j$(nproc) V=s 2>&1 | tee build.log | tail -100

      - name: Logi błędów (tylko przy niepowodzeniu)
        if: failure()
        run: |
          echo "=== Ostatnie 300 linii build.log ==="
          tail -300 build.log
          df -h

      - name: Zbieranie plików firmware
        if: success()
        run: |
          mkdir -p firmware
          find bin/targets/${TARGET}/${SUBTARGET}/ \
            -type f \( -name "*.bin" -o -name "*.img" -o -name "*.img.gz" \
                      -o -name "*.ubi" -o -name "*.trx" \) \
            -exec cp {} firmware/ \;

          cp bin/targets/${TARGET}/${SUBTARGET}/profiles.json  firmware/ 2>/dev/null || true
          cp bin/targets/${TARGET}/${SUBTARGET}/config.buildinfo firmware/ 2>/dev/null || true

          echo "=== Pliki firmware ==="
          ls -lh firmware/
          echo "=== Weryfikacja rozmiaru (powinien byc ~12-15MB) ==="
          find firmware/ -name "*.bin" -exec du -h {} \;

      - name: Upload firmware → GitHub Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: "openwrt-${{ env.VERSION }}-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ env.PROFILE }}-usb-16m-luci-build${{ github.run_number }}"
          path: firmware/
          retention-days: 30
          if-no-files-found: error

      - name: Tworzenie GitHub Release (opcjonalne)
        if: success() && github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "openwrt-${{ env.VERSION }}-usb-16m-luci-build${{ github.run_number }}"
          name: "OpenWrt ${{ env.VERSION }} | ${{ env.TARGET }}/${{ env.SUBTARGET }} | ${{ env.PROFILE }} | USB + 16MB flash + LuCI PL"
          body: |
            ## OpenWrt Build – USB + 16MB Flash + LuCI PL

            > **Uwaga:** Wymaga wymiany chipa flash 8MB → 16MB oraz przylutowania złącza USB.
            > Wgraj via TFTP, NIE przez webUI TP-Link.

            | Parametr         | Wartość |
            |------------------|---------|
            | Wersja OpenWrt   | `${{ env.VERSION }}` |
            | Target           | `${{ env.TARGET }}` |
            | Subtarget        | `${{ env.SUBTARGET }}` |
            | Profil           | `${{ env.PROFILE }}` |
            | Flash            | `16MB partition (DTS) – overlay ~8MB extra space` |
            | USB              | `kmod-usb2 kmod-usb-ledtrig-usbport` |
            | Interfejs        | `LuCI (język polski)` |
            | Usunięte pakiety | `ppp ppp-mod-pppoe` |
            | Dodatkowe pakiety| `${{ github.event.inputs.extra_packages || 'brak' }}` |
            | Commit źródłowy  | `${{ github.sha }}` |
          files: firmware/*
          draft: false
          prerelease: false
